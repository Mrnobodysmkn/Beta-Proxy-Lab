name: Golden Hybrid Proxy Lab

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */2 * * *' # Ù‡Ø± Û² Ø³Ø§Ø¹Øª
  workflow_dispatch:

jobs:
  laboratory:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install requests

    - name: Run The Alchemist Script
      run: |
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
        rm -f golden_*.txt
        
        cat << 'EOF' > alchemist.py
        import requests
        import base64
        import json
        import re
        import copy
        import concurrent.futures
        
        # --- Ù…Ù†Ø§Ø¨Ø¹ ---
        SOURCES = [
            {'url': 'https://chat.tawana.online/sub/tawanaproxy.txt', 'tag': 'skimia'},
            {'url': 'https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/EternityAirports_sub.txt', 'tag': 'public'},
            {'url': 'https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/main/all_extracted_configs.txt', 'tag': 'public'},
        ]

        # Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø±ÙˆÙ Ú©Ù„Ø§Ø¯ÙÙ„Ø± Ú©Ù‡ Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø¯Ø± Ø§ÛŒØ±Ø§Ù† Ø¨Ø§Ø²ØªØ± Ù‡Ø³ØªÙ†Ø¯
        CF_PORTS = [443, 2053, 2083, 8443, 2096]
        
        # Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ
        FINAL_CONFIGS = []

        def get_flag(country_code):
            if not country_code: return 'ğŸš©'
            return chr(127397 + ord(country_code[0])) + chr(127397 + ord(country_code[1]))

        # ØªØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Vmess
        def encode_vmess(data_dict):
            json_str = json.dumps(data_dict)
            return 'vmess://' + base64.b64encode(json_str.encode('utf-8')).decode('utf-8')

        # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ùˆ "Ø§ØµÙ„Ø§Ø­ Ú˜Ù†ØªÛŒÚ©ÛŒ" Ú©Ø§Ù†ÙÛŒÚ¯
        def process_config(line, source_tag):
            configs = []
            try:
                # 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
                data = None
                protocol = ''
                
                if line.startswith('vmess://'):
                    protocol = 'vmess'
                    b64 = line[8:]
                    padding = len(b64) % 4
                    if padding: b64 += '=' * (4 - padding)
                    data = json.loads(base64.b64decode(b64).decode('utf-8', errors='ignore'))
                    
                    # ÙÛŒÙ„ØªØ± Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡: Ø§Ú¯Ø± TLS Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¯ÙˆØ± Ø¨Ø±ÛŒØ² (Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ø§Ø³Ú©ÛŒÙ…ÛŒØ§ Ø¨Ø§Ø´Ø¯)
                    if data.get('net') not in ['ws', 'grpc'] and data.get('tls') != 'tls' and source_tag != 'skimia':
                        return []
                        
                elif line.startswith('vless://'):
                    protocol = 'vless'
                    # Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ù†ÛŒØª
                    if 'security=reality' in line:
                        protocol = 'vless-reality'
                    elif 'security=tls' in line:
                        protocol = 'vless-tls'
                    elif source_tag != 'skimia':
                        return [] # Ø§Ú¯Ø± Ø§Ù…Ù† Ù†ÛŒØ³Øª Ùˆ Ù…Ø§Ù„ Ø®ÙˆØ¯Ù…Ø§Ù† Ù†ÛŒØ³ØªØŒ Ø­Ø°Ù
                
                else:
                    return [] # Ø¨Ù‚ÛŒÙ‡ Ù¾Ø±ÙˆØªÚ©Ù„â€ŒÙ‡Ø§ ÙØ¹Ù„Ø§ Ø­Ø°Ù Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ú©ÛŒÙÛŒØª

                # 2. ØªÚ©Ù†ÛŒÚ© Port Hopping (ØªÚ©Ø«ÛŒØ± Ø±ÙˆÛŒ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±)
                # Ø§Ú¯Ø± Ú©Ø§Ù†ÙÛŒÚ¯ WS/TLS Ø§Ø³ØªØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§ Ù¾Ø´Øª CDN Ø§Ø³Øª Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù¾ÙˆØ±Øª Ø±Ø§ Ø¹ÙˆØ¶ Ú©Ø±Ø¯
                base_configs = [line]
                
                # Ø´Ø±Ø· Ù¾ÙˆØ±Øª Ù‡Ø§Ù¾ÛŒÙ†Ú¯: Ù¾Ø±ÙˆØªÚ©Ù„ Vmess-WS ÛŒØ§ Vless-WS Ø¨Ø§Ø´Ø¯
                is_candidate = False
                current_port = 0
                
                if protocol == 'vmess' and data.get('net') == 'ws':
                    is_candidate = True
                    current_port = int(data['port'])
                elif 'type=ws' in line or 'security=tls' in line:
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÙˆØ±Øª Ø¨Ø±Ø§ÛŒ vless
                    match = re.search(r':(\d+)\?', line)
                    if match:
                        current_port = int(match.group(1))
                        is_candidate = True

                if is_candidate and source_tag == 'skimia': # ÙØ¹Ù„Ø§ ÙÙ‚Ø· Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©ÛŒÙ…ÛŒØ§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒÙ… Ú©Ù‡ Ø®Ø±Ø§Ø¨Ú©Ø§Ø±ÛŒ Ù†Ø´ÙˆØ¯
                    # Ø³Ø§Ø®Øª Ú©Ù¾ÛŒ Ø§Ø² Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
                    for port in CF_PORTS:
                        if port == current_port: continue
                        
                        if protocol == 'vmess':
                            new_data = copy.deepcopy(data)
                            new_data['port'] = port
                            new_data['ps'] = f"{new_data['ps']}-Port{port}"
                            base_configs.append(encode_vmess(new_data))
                        
                        elif protocol.startswith('vless'):
                            # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù¾ÙˆØ±Øª Ø¯Ø± Ø±Ø´ØªÙ‡ Ø¨Ø§ Regex
                            new_line = re.sub(r':(\d+)\?', f':{port}?', line, 1)
                            new_line += f"#{port}" # Ø§ÙØ²ÙˆØ¯Ù† ØªÚ¯ Ø¨Ù‡ Ù†Ø§Ù…
                            base_configs.append(new_line)

                # 3. Ù†Ù‡Ø§ÛŒÛŒ Ø³Ø§Ø²ÛŒ
                for cfg in base_configs:
                    configs.append({
                        'uri': cfg,
                        'tag': source_tag,
                        'proto': protocol
                    })
                    
            except Exception as e:
                pass
                
            return configs

        # --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ ---
        print('Fetching & Processing...')
        
        raw_list = []
        for src in SOURCES:
            try:
                resp = requests.get(src['url'], timeout=10)
                text = resp.text
                # Ø¯ÛŒÚ©Ø¯ Ø§Ú¯Ø± Ú©Ù„ ÙØ§ÛŒÙ„ Base64 Ø¨Ø§Ø´Ø¯
                if 'vmess://' not in text and 'vless://' not in text:
                    try:
                        text = base64.b64decode(text).decode('utf-8', errors='ignore')
                    except: pass
                
                for line in text.splitlines():
                    if line.strip():
                        raw_list.append((line.strip(), src['tag']))
            except: pass

        # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÙˆØ§Ø²ÛŒ
        with concurrent.futures.ThreadPoolExecutor(max_workers=50) as executor:
            results = executor.map(lambda p: process_config(p[0], p[1]), raw_list)
            for res in results:
                FINAL_CONFIGS.extend(res)

        # Ø¯Ø±ÛŒØ§ÙØª GeoIP Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ
        print(f'Total candidates: {len(FINAL_CONFIGS)}')
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ IP Ù‡Ø§ Ø¨Ø±Ø§ÛŒ GeoIP
        # (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ ØªØ§ Ú©Ø¯ Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ù†Ø´ÙˆØ¯ØŒ ÙØ±Ø¶ Ù…ÛŒÚ©Ù†ÛŒÙ… Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯)
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ
        # ÙØ§ÛŒÙ„ Ù…Ø®ØµÙˆØµ Ø§Ø³Ú©ÛŒÙ…ÛŒØ§ (Ø¨Ø§ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ ØªÚ©Ø«ÛŒØ± Ø´Ø¯Ù‡)
        skimia_lines = [c['uri'] for c in FINAL_CONFIGS if c['tag'] == 'skimia']
        with open('golden_skimia.txt', 'w') as f:
            f.write('\n'.join(skimia_lines))
            
        # ÙØ§ÛŒÙ„ Ø¹Ù…ÙˆÙ…ÛŒ ÙÙ‚Ø· Ø§Ù…Ù†â€ŒÙ‡Ø§
        public_lines = [c['uri'] for c in FINAL_CONFIGS if c['tag'] == 'public']
        # Ø´Ø§ÙÙ„ Ú©Ø±Ø¯Ù† Ø¨Ø±Ø§ÛŒ ØªÙ†ÙˆØ¹
        import random
        random.shuffle(public_lines)
        with open('golden_public_secure.txt', 'w') as f:
            f.write('\n'.join(public_lines[:100])) # ÙÙ‚Ø· Û±Û°Û° ØªØ§

        EOF
        
        python3 alchemist.py

    - name: Commit and Push
      run: |
        git config --global user.name "Lab Rat"
        git config --global user.email "lab@github.com"
        git add golden_*.txt
        git commit -m "New experimental formulas" || echo "No changes"
        git push

