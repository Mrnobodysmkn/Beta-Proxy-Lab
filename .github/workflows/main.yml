name: Golden Hybrid Proxy Lab (Safe Mode)

permissions:
  contents: write

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  laboratory:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install requests

    - name: Run The Alchemist Script
      run: |
        rm -f golden_*.txt
        
        cat << 'EOF' > alchemist.py
        import requests
        import base64
        import json
        import re
        import copy
        import concurrent.futures
        import random
        
        SOURCES = [
            {'url': 'https://chat.tawana.online/sub/tawanaproxy.txt', 'tag': 'skimia'},
            {'url': 'https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/EternityAirports_sub.txt', 'tag': 'public'},
            {'url': 'https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/main/all_extracted_configs.txt', 'tag': 'public'},
        ]

        CF_PORTS = [443, 2053, 2083, 8443, 2096]
        FINAL_CONFIGS = []

        def encode_vmess(data_dict):
            return 'vmess://' + base64.b64encode(json.dumps(data_dict).encode('utf-8')).decode('utf-8')

        def process_config(line, source_tag):
            configs = []
            # ذخیره نسخه اصلی برای روز مبادا (Fallback)
            original_config = {'uri': line, 'tag': source_tag, 'proto': 'unknown'}
            
            try:
                line = line.strip()
                if not line: return []
                
                data = None
                protocol = ''
                is_candidate = False
                current_port = 0
                
                # --- تلاش برای پارس کردن ---
                if line.startswith('vmess://'):
                    protocol = 'vmess'
                    b64 = line[8:]
                    padding = len(b64) % 4
                    if padding: b64 += '=' * (4 - padding)
                    
                    try:
                        decoded = base64.b64decode(b64).decode('utf-8', errors='ignore')
                        data = json.loads(decoded)
                    except:
                        # اگر دیکد نشد، اگر مال اسکیمیاست برش گردان، وگرنه حذف
                        if source_tag == 'skimia': return [original_config]
                        return []

                    # فیلتر امنیتی (برای عمومی‌ها)
                    if data.get('net') not in ['ws', 'grpc'] and data.get('tls') != 'tls' and source_tag != 'skimia':
                        return []
                    
                    if data.get('net') == 'ws':
                        is_candidate = True
                        current_port = int(data.get('port', 0))

                elif line.startswith('vless://'):
                    protocol = 'vless'
                    # پارس کردن پورت برای vless
                    match = re.search(r':(\d+)\?', line) or re.search(r'vless://.*?@.*?:(\d+)', line)
                    if match:
                        current_port = int(match.group(1))
                        # شرط کاندید شدن: داشتن tls یا ws
                        if 'security=tls' in line or 'type=ws' in line or 'security=reality' in line:
                            is_candidate = True
                    
                    # فیلتر امنیتی برای عمومی‌ها
                    if not is_candidate and source_tag != 'skimia':
                         return []

                # --- اگر پردازش موفق بود، نسخه اصلی را به لیست اضافه کن ---
                configs.append({'uri': line, 'tag': source_tag, 'proto': protocol})

                # --- عملیات Port Hopping (فقط برای اسکیمیا) ---
                if is_candidate and source_tag == 'skimia' and current_port > 0:
                    for port in CF_PORTS:
                        if port == current_port: continue
                        
                        try:
                            if protocol == 'vmess' and data:
                                new_data = copy.deepcopy(data)
                                new_data['port'] = port
                                new_data['ps'] = f"{new_data.get('ps', 'config')}-P{port}"
                                configs.append({'uri': encode_vmess(new_data), 'tag': source_tag, 'proto': 'vmess'})
                            
                            elif protocol == 'vless':
                                # تغییر پورت در URL با Regex
                                # الگوی ۱: :port?
                                new_line = re.sub(r':(\d+)\?', f':{port}?', line, 1)
                                if new_line == line: 
                                    # الگوی ۲: انتهای آدرس بدون پارامتر
                                    new_line = re.sub(r':(\d+)$', f':{port}', line, 1)
                                    # الگوی ۳: قبل از #
                                    new_line = re.sub(r':(\d+)#', f':{port}#', line, 1)
                                
                                # تغییر نام (بعد از #)
                                if '#' in new_line:
                                    parts = new_line.split('#')
                                    new_line = f"{parts[0]}#{parts[1]}-P{port}"
                                else:
                                    new_line += f"#{port}"
                                    
                                configs.append({'uri': new_line, 'tag': source_tag, 'proto': 'vless'})
                        except:
                            continue # اگر ساخت کپی شکست خورد، ادامه بده

            except Exception as e:
                # اگر هر خطایی رخ داد، اما لینک مال اسکیمیا بود، نسخه اصلی را حفظ کن
                if source_tag == 'skimia':
                    return [original_config]
                return []
                
            return configs

        print('Fetching & Processing...')
        raw_list = []
        for src in SOURCES:
            try:
                print(f"Downloading {src['tag']}...")
                resp = requests.get(src['url'], timeout=15)
                text = resp.text.strip()
                
                # دیکد فایل سابسکرایب (Base64)
                if 'vmess://' not in text and 'vless://' not in text:
                    try:
                        # تلاش برای تمیز کردن و دیکد
                        cleaned_text = text.replace(' ', '').replace('\n', '')
                        decoded_text = base64.b64decode(cleaned_text).decode('utf-8', errors='ignore')
                        text = decoded_text
                    except:
                        pass # شاید فایل متنی ساده باشد
                
                lines = text.splitlines()
                print(f"Source {src['tag']} lines: {len(lines)}")
                for line in lines:
                    if line.strip():
                        raw_list.append((line.strip(), src['tag']))
            except Exception as e:
                print(f"Error fetching {src['url']}: {e}")

        with concurrent.futures.ThreadPoolExecutor(max_workers=50) as executor:
            results = executor.map(lambda p: process_config(p[0], p[1]), raw_list)
            for res in results:
                FINAL_CONFIGS.extend(res)

        print(f'Total Configs Generated: {len(FINAL_CONFIGS)}')

        # ذخیره فایل‌ها
        skimia_lines = [c['uri'] for c in FINAL_CONFIGS if c['tag'] == 'skimia']
        print(f"Skimia Final Count: {len(skimia_lines)}")
        
        with open('golden_skimia.txt', 'w', encoding='utf-8') as f:
            f.write('\n'.join(skimia_lines))
            
        public_lines = [c['uri'] for c in FINAL_CONFIGS if c['tag'] == 'public']
        random.shuffle(public_lines)
        with open('golden_public_secure.txt', 'w', encoding='utf-8') as f:
            f.write('\n'.join(public_lines[:150]))

        EOF
        
        python3 alchemist.py

    - name: Commit and Push
      run: |
        git config --global user.name "Lab Rat"
        git config --global user.email "lab@github.com"
        git add golden_*.txt
        git commit -m "Fix parsing issue with fallback" || echo "No changes"
        git push
